"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.LocalStorageACECache = void 0;
var tslib_1 = require("tslib");
var BaseAdaptiveCardExtensionCache_1 = require("./BaseAdaptiveCardExtensionCache");
var sp_diagnostics_1 = require("@microsoft/sp-diagnostics");
/**
 * LKG Cache which uses LocalStorage as its backing store.
 *
 * @internal
 */
var LocalStorageACECache = /** @class */ (function (_super) {
    tslib_1.__extends(LocalStorageACECache, _super);
    function LocalStorageACECache() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        /**
         * In-memory cache to avoid main thread cost of repeatedly parsing ACE LKG cached strings (greater than 50kB).
         */
        _this._cachedMap = new Map();
        return _this;
    }
    LocalStorageACECache.getKey = function (siteId, listItemUniqueId) {
        return "AdaptiveCardExtension_LKG_".concat(siteId, "_").concat(listItemUniqueId);
    };
    Object.defineProperty(LocalStorageACECache, "instance", {
        get: function () {
            if (this._instance === undefined) {
                this._instance = new LocalStorageACECache();
            }
            return this._instance;
        },
        enumerable: false,
        configurable: true
    });
    LocalStorageACECache.prototype.save = function (key, instanceId, cacheObject) {
        var monitor = new sp_diagnostics_1._QosMonitor('ACE.LocalStorage.save');
        try {
            var localStorageEntry = this._getLocalStorageEntry(key);
            localStorageEntry.set(instanceId, cacheObject);
            var mapEntriesArray = Array.from(localStorageEntry.entries());
            localStorage.setItem(key, JSON.stringify(mapEntriesArray));
            monitor.writeSuccess();
        }
        catch (e) {
            var alias = cacheObject.cachedCard.cardProperties.title || '';
            monitor.writeUnexpectedFailure('', e, {
                alias: alias,
                instanceId: instanceId
            });
        }
    };
    LocalStorageACECache.prototype.getFromSource = function (key, instanceId) {
        var monitor = new sp_diagnostics_1._QosMonitor('ACE.LocalStorage.get');
        try {
            var entries = this._getLocalStorageEntry(key);
            var cachedObject = entries.get(instanceId);
            if (cachedObject) {
                monitor.writeSuccess();
            }
            else {
                monitor.writeExpectedFailure('cacheMiss', undefined, { instanceId: instanceId });
            }
            return Promise.resolve(cachedObject);
        }
        catch (e) {
            monitor.writeUnexpectedFailure('', e, { instanceId: instanceId });
            return Promise.resolve(undefined);
        }
    };
    LocalStorageACECache.prototype._getLocalStorageEntry = function (key) {
        var cacheEntry = this._cachedMap.get(key);
        // If already cached in-memory, do not expensive JSON.parse again.
        if (cacheEntry) {
            return cacheEntry;
        }
        // Otherwise, parse LKG JSON string and cache in-memory.
        var cacheString = localStorage.getItem(key);
        var aceLkgMap = cacheString
            ? new Map(JSON.parse(cacheString))
            : new Map();
        this._cachedMap.set(key, aceLkgMap);
        return aceLkgMap;
    };
    return LocalStorageACECache;
}(BaseAdaptiveCardExtensionCache_1.BaseAdaptiveCardExtensionCache));
exports.LocalStorageACECache = LocalStorageACECache;
//# sourceMappingURL=LocalStorageACECache.js.map