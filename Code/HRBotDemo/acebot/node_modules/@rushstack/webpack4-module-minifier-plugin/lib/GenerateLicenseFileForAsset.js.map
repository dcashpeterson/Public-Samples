{"version":3,"file":"GenerateLicenseFileForAsset.js","sourceRoot":"","sources":["../src/GenerateLicenseFileForAsset.ts"],"names":[],"mappings":";AAAA,4FAA4F;AAC5F,2DAA2D;;;;;;;;;;;;;;;;;;;;;;;;;;AAE3D,2CAA6B;AAE7B,qDAA+C;AAS/C,SAAS,cAAc,CAAC,SAA8B,EAAE,eAA2B;IACjF,MAAM,WAAW,GAAgB,IAAI,GAAG,EAAE,CAAC;IAE3C,KAAK,MAAM,QAAQ,IAAI,SAAS,EAAE;QAChC,MAAM,GAAG,GAA4B,eAAe,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QACnE,IAAI,CAAC,GAAG,EAAE;YACR,SAAS;SACV;QAED,MAAM,EAAE,MAAM,EAAE,aAAa,EAAE,GAAG,GAAG,CAAC;QACtC,MAAM,OAAO,GAAsB,aAAa,CAAC,OAAO,IAAI,CAAC,aAAa,CAAC,CAAC;QAC5E,KAAK,MAAM,SAAS,IAAI,OAAO,EAAE;YAC/B,MAAM,EAAE,QAAQ,EAAE,iBAAiB,EAAE,GAAG,SAAS,CAAC,WAEjD,CAAC;YACF,IAAI,iBAAiB,EAAE;gBACrB,KAAK,MAAM,OAAO,IAAI,iBAAiB,EAAE;oBACvC,MAAM,KAAK,GAAW,OAAO,CAAC,IAAI,KAAK,MAAM,CAAC,CAAC,CAAC,KAAK,OAAO,CAAC,KAAK,IAAI,CAAC,CAAC,CAAC,KAAK,OAAO,CAAC,KAAK,MAAM,CAAC;oBAClG,WAAW,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;iBACxB;aACF;SACF;KACF;IAED,OAAO,WAAW,CAAC;AACrB,CAAC;AAED;;;;;;;;GAQG;AACH,SAAgB,2BAA2B,CACzC,WAA4C,EAC5C,KAAiB,EACjB,eAA2B;IAE3B,uCAAuC;IACvC,MAAM,QAAQ,GAAgB,cAAc,CAAC,KAAK,CAAC,OAAO,EAAE,eAAe,CAAC,CAAC;IAE7E,MAAM,SAAS,GAAW,KAAK,CAAC,QAAQ,CAAC;IAEzC,IAAI,MAAM,GAAW,EAAE,CAAC;IAExB,IAAI,QAAQ,CAAC,IAAI,EAAE;QACjB,+FAA+F;QAC/F,MAAM,aAAa,GAAiB,IAAI,8BAAY,EAAE,CAAC;QACvD,QAAQ,CAAC,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE;YAC3B,aAAa,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;QAC7B,CAAC,CAAC,CAAC;QACH,MAAM,eAAe,GAAW,GAAG,SAAS,cAAc,CAAC;QAC3D,WAAW,CAAC,MAAM,CAAC,eAAe,CAAC,GAAG,aAAa,CAAC;QACpD,MAAM,GAAG,0CAA0C,IAAI,CAAC,QAAQ,CAAC,eAAe,CAAC,OAAO,CAAC;KAC1F;IAED,OAAO,MAAM,CAAC;AAChB,CAAC;AAxBD,kEAwBC","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport * as path from 'path';\nimport type * as webpack from 'webpack';\nimport { ConcatSource } from 'webpack-sources';\nimport type {\n  IAssetInfo,\n  IModuleMap,\n  IModuleInfo,\n  IExtendedModule,\n  _IAcornComment\n} from './ModuleMinifierPlugin.types';\n\nfunction getAllComments(moduleIds: (string | number)[], minifiedModules: IModuleMap): Set<string> {\n  const allComments: Set<string> = new Set();\n\n  for (const moduleId of moduleIds) {\n    const mod: IModuleInfo | undefined = minifiedModules.get(moduleId);\n    if (!mod) {\n      continue;\n    }\n\n    const { module: webpackModule } = mod;\n    const modules: IExtendedModule[] = webpackModule.modules || [webpackModule];\n    for (const submodule of modules) {\n      const { comments: subModuleComments } = submodule.factoryMeta as {\n        comments?: Set<_IAcornComment>;\n      };\n      if (subModuleComments) {\n        for (const comment of subModuleComments) {\n          const value: string = comment.type === 'Line' ? `//${comment.value}\\n` : `/*${comment.value}*/\\n`;\n          allComments.add(value);\n        }\n      }\n    }\n  }\n\n  return allComments;\n}\n\n/**\n * Generates a companion asset containing all extracted comments. If it is non-empty, returns a banner comment directing users to said companion asset.\n *\n * @param compilation - The webpack compilation\n * @param asset - The asset to process\n * @param minifiedModules - The minified modules to pull comments from\n * @param assetName - The name of the asset\n * @public\n */\nexport function generateLicenseFileForAsset(\n  compilation: webpack.compilation.Compilation,\n  asset: IAssetInfo,\n  minifiedModules: IModuleMap\n): string {\n  // Extracted comments from the modules.\n  const comments: Set<string> = getAllComments(asset.modules, minifiedModules);\n\n  const assetName: string = asset.fileName;\n\n  let banner: string = '';\n\n  if (comments.size) {\n    // There are license comments in this chunk, so generate the companion file and inject a banner\n    const licenseSource: ConcatSource = new ConcatSource();\n    comments.forEach((comment) => {\n      licenseSource.add(comment);\n    });\n    const licenseFileName: string = `${assetName}.LICENSE.txt`;\n    compilation.assets[licenseFileName] = licenseSource;\n    banner = `/*! For license information please see ${path.basename(licenseFileName)} */\\n`;\n  }\n\n  return banner;\n}\n"]}