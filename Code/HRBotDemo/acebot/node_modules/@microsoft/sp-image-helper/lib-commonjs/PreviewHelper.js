"use strict";
/**
 * utility functions to determine whether file type supports preview.
 * and return the preview image url based on the file url
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.PreviewHelper = void 0;
var tslib_1 = require("tslib");
var sp_core_library_1 = require("@microsoft/sp-core-library");
var sp_diagnostics_1 = require("@microsoft/sp-diagnostics");
var SPAlternativeUrls = tslib_1.__importStar(require("@ms/odsp-utilities/lib/alternativeUrls/SPAlternativeUrls"));
var PreviewUtility_1 = require("./PreviewUtility");
var SPResourcePath_1 = require("./SPResourcePath");
var ThumbnailUrlGenerator_1 = require("./ThumbnailUrlGenerator");
var MAX_BANNERURL_LEN = 255;
/**
 * @internal
 */
var PreviewHelper = /** @class */ (function () {
    function PreviewHelper() {
    }
    /**
     * Returns true if the filetype is supported for preview.
     */
    PreviewHelper.hasThumbnailOrFileTypeSupportsPreview = function (fileType, thumbnail) {
        return !!thumbnail || (!!fileType && PreviewUtility_1.PreviewUtility.getPreviewSupportedMap.has(fileType.toLowerCase()));
    };
    /**
     * Returns preview image URL for supported file extensions using getPreview.aspx service
     * Must be given unencoded strings
     */
    PreviewHelper.getPreviewImageUrl = function (fileType, thumbnail, baseUrl, path, siteId, webId, uniqueId, width, isBannerImageUrl, callerId, originalWidth, originalHeight) {
        if (!isBannerImageUrl && ThumbnailUrlGenerator_1._ThumbnailUrlGenerator.instance.isVROOMThumbnailEnabled()) {
            var qosMonitor = new sp_diagnostics_1._QosMonitor("DocVizCaller");
            qosMonitor.writeSuccess({ service: callerId || 'unknown' });
        }
        var resolution = PreviewUtility_1.PreviewUtility.normalizeWidthToResolution(width);
        return PreviewHelper._generateGetPreviewImageUrl(fileType, baseUrl, path, siteId, webId, uniqueId, resolution, isBannerImageUrl, originalWidth, originalHeight);
    };
    PreviewHelper._generateGetPreviewImageUrl = function (fileType, baseUrl, path, siteId, webId, uniqueId, resolution, isBannerImageUrl, originalWidth, originalHeight) {
        if (path) {
            var pathUri = new SPResourcePath_1.SPResourcePath(path);
            if (pathUri.format === SPResourcePath_1._SPResourcePathFormat.absolute) {
                // Honor cross geo Host from path
                baseUrl = pathUri.authority;
                path = pathUri.path;
            }
            // Fix for WEX Bug #1129103 and Bug #1137680. Always encode so that setSearchParam works correctly with symbols.
            // If the path has a forward slash, then it hasn't been encoded yet.
            if (path.indexOf('/') >= 0) {
                path = encodeURIComponent(path);
            }
        }
        var baseUri = baseUrl && !!baseUrl.length ? new SPResourcePath_1.SPResourcePath(baseUrl) : undefined;
        var url = baseUrl && !!baseUrl.length
            ? new SPResourcePath_1.SPResourcePath(baseUri === null || baseUri === void 0 ? void 0 : baseUri.authority, PreviewHelper.PREVIEW_HANDLER_PATH)
            : new SPResourcePath_1.SPResourcePath(PreviewHelper.PREVIEW_HANDLER_PATH);
        if (resolution !== undefined && !isNaN(resolution)) {
            url.searchParams.set(PreviewHelper.RESOLUTION, resolution.toString());
        }
        // Convert to guids for brevity as final URL should be minimal to fit in 255 SP URL limit
        var siteGuid = sp_core_library_1.Guid.tryParse(siteId);
        var webGuid = sp_core_library_1.Guid.tryParse(webId);
        var fileGuid = sp_core_library_1.Guid.tryParse(uniqueId);
        var cdnEnabled = 'True' === SPAlternativeUrls.tryGetAlternativeUrl('PrivateCDNEnabled');
        var validGuidProvided = siteGuid &&
            webGuid &&
            fileGuid &&
            !PreviewUtility_1.EMPTY_GUIDS.has(uniqueId) &&
            !PreviewUtility_1.EMPTY_GUIDS.has(webId) &&
            !PreviewUtility_1.EMPTY_GUIDS.has(siteId);
        // Giving preference to path over Guid to improve CDN Rewrite coverage
        var pathOverGuid = cdnEnabled &&
            sp_core_library_1._SPFlight.isEnabled(60134 /* WEXUsePathOverGuidForBannerImageUrl */) &&
            isBannerImageUrl &&
            !!path &&
            url.toString().length + encodeURIComponent(path).length <= MAX_BANNERURL_LEN;
        var isPathUrl = false;
        if (validGuidProvided && !pathOverGuid) {
            url.searchParams.set(PreviewHelper.GUID_SITE, siteGuid.toString().replace(/-/g, ''));
            url.searchParams.set(PreviewHelper.GUID_WEB, webGuid.toString().replace(/-/g, ''));
            url.searchParams.set(PreviewHelper.GUID_FILE, fileGuid.toString().replace(/-/g, ''));
        }
        else if (path) {
            url.setSearchParam(PreviewHelper.PATH, path);
            isPathUrl = true;
        }
        else {
            // Neither valid Guid nor Path provided, return undefined instead of a failed attempt to SPO
            return undefined;
        }
        if (!isBannerImageUrl) {
            url.searchParams.set(PreviewUtility_1.PreviewUtility.CLIENT_TYPE, PreviewUtility_1.PreviewUtility.MODERN_WEB_PART);
        }
        // Path already has file type
        if (isBannerImageUrl && fileType && !isPathUrl) {
            url.searchParams.set(PreviewHelper.EXT, fileType);
            if (url.toString().length >= MAX_BANNERURL_LEN) {
                url.searchParams.delete(PreviewHelper.EXT);
            }
        }
        if (isBannerImageUrl && originalWidth && originalHeight) {
            url.searchParams.set(PreviewHelper.ORIGINAL_WIDTH, originalWidth.toString());
            url.searchParams.set(PreviewHelper.ORIGINAL_HEIGHT, originalHeight.toString());
            if (url.toString().length >= MAX_BANNERURL_LEN) {
                url.searchParams.delete(PreviewHelper.ORIGINAL_WIDTH);
                url.searchParams.delete(PreviewHelper.ORIGINAL_HEIGHT);
            }
        }
        return url.toString();
    };
    PreviewHelper.RESOLUTION = 'resolution';
    PreviewHelper.GUID_SITE = 'guidSite';
    PreviewHelper.GUID_WEB = 'guidWeb';
    PreviewHelper.GUID_FILE = 'guidFile';
    PreviewHelper.PATH = 'path';
    PreviewHelper.EXT = 'ext';
    PreviewHelper.ORIGINAL_WIDTH = 'ow';
    PreviewHelper.ORIGINAL_HEIGHT = 'oh';
    PreviewHelper.WIDTH = 'width';
    PreviewHelper.WIDTH_SHORT = 'w';
    PreviewHelper.HEIGHT_SHORT = 'h';
    PreviewHelper.VIEWPORT_LEFT = 'vl';
    PreviewHelper.VIEWPORT_TOP = 'vt';
    PreviewHelper.VIEWPORT_WIDTH = 'vw';
    PreviewHelper.VIEWPORT_HEIGHT = 'vh';
    PreviewHelper.CALLER_STACK = 'cs';
    PreviewHelper.INPUT_FORMAT = 'inputFormat';
    PreviewHelper.DOCID = 'docid';
    PreviewHelper.PREVIEW_HANDLER_PATH = '/_layouts/15/getpreview.ashx';
    // video file extensions within the support preview file types
    PreviewHelper.VIDEO_EXTENSIONS = [
        '3gp',
        'asf',
        'avi',
        'mkv',
        'mod',
        'mov',
        'mp4',
        'mpeg',
        'mpg',
        'mts',
        'ts',
        'vob',
        'wmv'
    ];
    PreviewHelper.IMAGE_EXTENSIONS = [
        'gif',
        'jpg',
        'jpeg',
        'bmp',
        'dib',
        'tif',
        'tiff',
        'ico',
        'png',
        'jxr',
        'svg'
    ];
    return PreviewHelper;
}());
exports.PreviewHelper = PreviewHelper;
//# sourceMappingURL=PreviewHelper.js.map