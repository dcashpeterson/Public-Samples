{"version":3,"file":"mechanics.js","sourceRoot":"","sources":["../src/mechanics.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport type { TSESLint, TSESTree } from '@typescript-eslint/experimental-utils';\nimport { AST_NODE_TYPES, ESLintUtils } from '@typescript-eslint/experimental-utils';\n\nimport { PackletAnalyzer, IAnalyzerError, InputFileMessageIds, ImportMessageIds } from './PackletAnalyzer';\n\nexport type MessageIds = InputFileMessageIds | ImportMessageIds;\ntype Options = [];\n\nconst mechanics: TSESLint.RuleModule<MessageIds, Options> = {\n  meta: {\n    type: 'problem',\n    messages: {\n      // InputFileMessageIds\n      'file-in-packets-folder': 'The \"packlets\" folder must not contain regular source files',\n      'invalid-packlet-name':\n        'Invalid packlet name \"{{packletName}}\".' +\n        ' The name must be lowercase alphanumeric words separated by hyphens. Example: \"my-packlet\"',\n      'misplaced-packlets-folder': 'The packlets folder must be located at \"{{expectedPackletsFolder}}\"',\n      'missing-src-folder': 'Expecting to find a \"src\" folder at: {{srcFolderPath}}',\n      'missing-tsconfig':\n        'In order to use @rushstack/eslint-plugin-packlets, your ESLint config file' +\n        ' must configure the TypeScript parser',\n      'packlet-folder-case': 'The packlets folder must be all lower case: {{packletsFolderPath}}',\n\n      // ImportMessageIds\n      'bypassed-entry-point':\n        'The import statement does not use the packlet\\'s entry point \"{{entryPointModulePath}}\"',\n      'circular-entry-point': 'Files under a packlet folder must not import from their own index.ts file',\n      'packlet-importing-project-file':\n        'A local project file cannot be imported.' +\n        \" A packlet's dependencies must be NPM packages and/or other packlets.\"\n    },\n    schema: [\n      {\n        type: 'object',\n        additionalProperties: false\n      }\n    ],\n    docs: {\n      description: 'Check that file paths and imports follow the basic mechanics for the packlet formalism',\n      // Deprecated in ESLint v8; Keep for backwards compatibility\n      category: 'Best Practices',\n      recommended: 'warn',\n      url: 'https://www.npmjs.com/package/@rushstack/eslint-plugin-packlets'\n    } as TSESLint.RuleMetaDataDocs\n  },\n\n  create: (context: TSESLint.RuleContext<MessageIds, Options>) => {\n    // Example: /path/to/my-project/src/packlets/my-packlet/index.ts\n    const inputFilePath: string = context.getFilename();\n\n    // Example: /path/to/my-project/tsconfig.json\n    const tsconfigFilePath: string | undefined = ESLintUtils.getParserServices(\n      context\n    ).program.getCompilerOptions()['configFilePath'] as string;\n\n    const packletAnalyzer: PackletAnalyzer = PackletAnalyzer.analyzeInputFile(\n      inputFilePath,\n      tsconfigFilePath\n    );\n    if (packletAnalyzer.nothingToDo) {\n      return {};\n    }\n\n    return {\n      // Match the first node in the source file.  Ideally we should be matching \"Program > :first-child\"\n      // so a warning doesn't highlight the whole file.  But that's blocked behind a bug in the query selector:\n      // https://github.com/estools/esquery/issues/114\n      Program: (node: TSESTree.Node): void => {\n        if (packletAnalyzer.error) {\n          context.report({\n            node: node,\n            messageId: packletAnalyzer.error.messageId,\n            data: packletAnalyzer.error.data\n          });\n        }\n      },\n\n      // ImportDeclaration matches these forms:\n      //   import { X } from '../../packlets/other-packlet';\n      //   import X from '../../packlets/other-packlet';\n      //   import type { X, Y } from '../../packlets/other-packlet';\n      //   import * as X from '../../packlets/other-packlet';\n      //\n      // ExportNamedDeclaration matches these forms:\n      //   export { X } from '../../packlets/other-packlet';\n      //\n      // ExportAllDeclaration matches these forms:\n      //   export * from '../../packlets/other-packlet';\n      //   export * as X from '../../packlets/other-packlet';\n      'ImportDeclaration, ExportNamedDeclaration, ExportAllDeclaration': (\n        node: TSESTree.ImportDeclaration | TSESTree.ExportNamedDeclaration | TSESTree.ExportAllDeclaration\n      ): void => {\n        if (node.source?.type === AST_NODE_TYPES.Literal) {\n          if (packletAnalyzer.projectUsesPacklets) {\n            // Extract the import/export module path\n            // Example: \"../../packlets/other-packlet\"\n            const modulePath = node.source.value;\n            if (typeof modulePath !== 'string') {\n              return;\n            }\n\n            if (!(modulePath.startsWith('.') || modulePath.startsWith('..'))) {\n              // It's not a local import.\n\n              // Examples:\n              //   import { X } from \"npm-package\";\n              //   import { X } from \"raw-loader!./webpack-file.ts\";\n              return;\n            }\n\n            const lint: IAnalyzerError | undefined = packletAnalyzer.analyzeImport(modulePath);\n            if (lint) {\n              context.report({\n                node: node,\n                messageId: lint.messageId,\n                data: lint.data\n              });\n            }\n          }\n        }\n      }\n    };\n  }\n};\n\nexport { mechanics };\n"]}