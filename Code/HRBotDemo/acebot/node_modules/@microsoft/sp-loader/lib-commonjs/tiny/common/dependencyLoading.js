"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.loadPathDependencies = exports.loadComponentDependencies = void 0;
var tslib_1 = require("tslib");
var sp_telemetry_1 = require("@ms/sp-telemetry");
var ComponentStore_1 = tslib_1.__importDefault(require("../../stores/ComponentStore"));
var ManifestStore_1 = tslib_1.__importDefault(require("../../stores/ManifestStore"));
var killSwitches_1 = require("./killSwitches");
/**
 * Load all the component dependencies of an SPFx component.
 *
 * @param loader - Module loader instance.
 * @param manifest - Manifest of the dependent component.
 * @param depNames - Array of dependency names.
 *
 * @returns An array of Promises resolving to a respective dependency.
 */
function loadComponentDependencies(loader, manifest, depNames) {
    var deps = [];
    var scriptResources = manifest.loaderConfig.scriptResources;
    var _loop_1 = function (depName) {
        var resource = scriptResources[depName];
        if (!resource.shouldNotPreload && resource.type === 'component') {
            var dep = loadComponentDependency(loader, depName, resource);
            if (dep) {
                deps.push(dep.catch(function (originalError) {
                    var monitor = new sp_telemetry_1._QosMonitor('SPLoader.loadComponentDependenciesFailures');
                    var mId = manifest.id, mVersion = manifest.version;
                    var _a = resource, id = _a.id, version = _a.version;
                    monitor.writeUnexpectedFailure(undefined, new Error("Could not load dependency ".concat(id, "_").concat(version, " for dependent ").concat(mId, "_").concat(mVersion)), { originalError: originalError });
                    throw originalError;
                }));
            }
        }
    };
    for (var _i = 0, depNames_1 = depNames; _i < depNames_1.length; _i++) {
        var depName = depNames_1[_i];
        _loop_1(depName);
    }
    return deps;
}
exports.loadComponentDependencies = loadComponentDependencies;
/**
 * Load all the path dependencies of an SPFx component.
 *
 * @param loader - Module loader instance.
 * @param manifest - Manifest of the dependent component.
 * @param depNames - Array of dependency names.
 *
 * @returns An array of Promises resolving to a respective dependency.
 */
function loadPathDependencies(loader, manifest, depNames) {
    var deps = [];
    var loadedPathDeps = new Set();
    var _a = manifest.loaderConfig, entryModuleId = _a.entryModuleId, scriptResources = _a.scriptResources;
    var _loop_2 = function (depName) {
        var resource = scriptResources[depName];
        if (!resource.shouldNotPreload &&
            (resource.type === 'path' || resource.type === 'localizedPath') &&
            !loadedPathDeps.has(depName) &&
            depName !== entryModuleId) {
            loadedPathDeps.add(depName);
            var dep = loadPathDependency(loader, manifest, depName, resource, loadedPathDeps);
            if (!(0, killSwitches_1.isLogLoadPathDependenciesFailuresKSActivated)()) {
                dep.catch(function (originalError) {
                    var monitor = new sp_telemetry_1._QosMonitor('SPLoader.loadPathDependenciesFailures');
                    var mId = manifest.id, mVersion = manifest.version;
                    var path = resource.path;
                    monitor.writeUnexpectedFailure(undefined, new Error("Could not load path dependency ".concat(depName, "(").concat(path, ") for dependent ").concat(mId, "_").concat(mVersion)), { originalError: originalError });
                    throw originalError;
                });
            }
            deps.push(dep);
        }
    };
    for (var _i = 0, depNames_2 = depNames; _i < depNames_2.length; _i++) {
        var depName = depNames_2[_i];
        _loop_2(depName);
    }
    return deps;
}
exports.loadPathDependencies = loadPathDependencies;
/**
 * Load a component dependency.
 *
 * @param loader - Module loader instance.
 * @param name - Name of the dependency to load.
 * @param resource - Module configuration of the dependency.
 *
 * @returns A promise resolving to the dependency or undefined if the dependency did not need to be loaded.
 */
function loadComponentDependency(loader, name, resource) {
    var dep;
    var depManifest = ManifestStore_1.default.instance.tryGetManifest(resource.id, resource.version);
    if (depManifest) {
        // If the dependency has been loaded then skip trying to load it
        var depReference = ComponentStore_1.default.instance.tryGetComponentReference(depManifest.id, depManifest.version);
        if (!depReference) {
            dep = loader.loadComponent(depManifest);
        }
    }
    else {
        if (resource.failoverPath) {
            dep = loader.load(name);
        }
        else {
            dep = ManifestStore_1.default.instance
                .requestManifest(resource.id, resource.version)
                .then(function (m) { return loader.loadComponent(m); });
        }
    }
    return dep;
}
/**
 * Load a path dependency.
 *
 * @param loader - Module loader instance.
 * @param manifest - Manifest of the dependent component.
 * @param name - Name of the path dependency.
 * @param resource - Configuration of the path dependency.
 * @param loadedPathDependencies - Set of already loaded path dependencies.
 */
function loadPathDependency(loader, manifest, name, resource, loadedPathDependencies) {
    var globalDeps = [];
    if (resource.globalDependencies) {
        for (var _i = 0, _a = resource.globalDependencies; _i < _a.length; _i++) {
            var gDep = _a[_i];
            // If a path dependency is a dependency of another path we should still only load it once
            if (!loadedPathDependencies.has(gDep)) {
                loadedPathDependencies.add(gDep);
                var gResource = manifest.loaderConfig.scriptResources[gDep];
                globalDeps.push(loadPathDependency(loader, manifest, gDep, gResource, loadedPathDependencies));
            }
        }
    }
    return Promise.all(globalDeps).then(function () { return loader.loadEntryPoint(manifest, name, resource.globalName); });
}
//# sourceMappingURL=dependencyLoading.js.map