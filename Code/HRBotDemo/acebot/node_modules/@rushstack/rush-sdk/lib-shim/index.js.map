{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport * as path from 'path';\nimport {\n  JsonFile,\n  type JsonObject,\n  type IPackageJson,\n  PackageJsonLookup,\n  Executable,\n  Terminal,\n  ConsoleTerminalProvider\n} from '@rushstack/node-core-library';\nimport type { SpawnSyncReturns } from 'child_process';\nimport {\n  RUSH_LIB_NAME,\n  RUSH_LIB_PATH_ENV_VAR_NAME,\n  type RushLibModuleType,\n  _require,\n  requireRushLibUnderFolderPath,\n  tryFindRushJsonLocation,\n  sdkContext\n} from './helpers';\n\nconst verboseEnabled: boolean = typeof process !== 'undefined' && process.env.RUSH_SDK_DEBUG === '1';\nconst terminal: Terminal = new Terminal(\n  new ConsoleTerminalProvider({\n    verboseEnabled\n  })\n);\n\ndeclare const global: typeof globalThis & {\n  ___rush___rushLibModule?: RushLibModuleType;\n  ___rush___rushLibModuleFromEnvironment?: RushLibModuleType;\n  ___rush___rushLibModuleFromInstallAndRunRush?: RushLibModuleType;\n};\n\nlet errorMessage: string = '';\n\n// SCENARIO 1:  Rush's PluginManager has initialized \"rush-sdk\" with Rush's own instance of rush-lib.\n// The Rush host process will assign \"global.___rush___rushLibModule\" before loading the plugin.\nif (sdkContext.rushLibModule === undefined) {\n  sdkContext.rushLibModule =\n    global.___rush___rushLibModule ||\n    global.___rush___rushLibModuleFromEnvironment ||\n    global.___rush___rushLibModuleFromInstallAndRunRush;\n}\n\n// SCENARIO 2:  The project importing \"rush-sdk\" has installed its own instance of \"rush-lib\"\n// as a package.json dependency.  For example, this is used by the Jest tests for Rush plugins.\nif (sdkContext.rushLibModule === undefined) {\n  const importingPath: string | null | undefined = module?.parent?.filename;\n  if (importingPath) {\n    const callerPackageFolder: string | undefined =\n      PackageJsonLookup.instance.tryGetPackageFolderFor(importingPath);\n\n    if (callerPackageFolder !== undefined) {\n      const callerPackageJson: IPackageJson = _require(path.join(callerPackageFolder, 'package.json'));\n\n      // Does the caller properly declare a dependency on rush-lib?\n      if (\n        (callerPackageJson.dependencies && callerPackageJson.dependencies[RUSH_LIB_NAME] !== undefined) ||\n        (callerPackageJson.devDependencies &&\n          callerPackageJson.devDependencies[RUSH_LIB_NAME] !== undefined) ||\n        (callerPackageJson.peerDependencies &&\n          callerPackageJson.peerDependencies[RUSH_LIB_NAME] !== undefined)\n      ) {\n        // Try to resolve rush-lib from the caller's folder\n        terminal.writeVerboseLine(`Try to load ${RUSH_LIB_NAME} from caller package`);\n        try {\n          sdkContext.rushLibModule = requireRushLibUnderFolderPath(callerPackageFolder);\n        } catch (error) {\n          // If we fail to resolve it, ignore the error\n          terminal.writeVerboseLine(`Failed to load ${RUSH_LIB_NAME} from caller package`);\n        }\n\n        // If two different libraries invoke `rush-sdk`, and one of them provides \"rush-lib\"\n        // then the first version to be loaded wins.  We do not support side-by-side instances of \"rush-lib\".\n        if (sdkContext.rushLibModule !== undefined) {\n          // to track which scenario is active and how it got initialized.\n          global.___rush___rushLibModule = sdkContext.rushLibModule;\n          terminal.writeVerboseLine(`Loaded ${RUSH_LIB_NAME} from caller`);\n        }\n      }\n    }\n  }\n}\n\n// SCENARIO 3: A tool or script has been invoked as a child process by an instance of \"rush-lib\" and can use the\n// version that invoked it. In this case, use process.env._RUSH_LIB_PATH to find \"rush-lib\".\nif (sdkContext.rushLibModule === undefined) {\n  const rushLibPath: string | undefined = process.env[RUSH_LIB_PATH_ENV_VAR_NAME];\n  if (rushLibPath) {\n    terminal.writeVerboseLine(\n      `Try to load ${RUSH_LIB_NAME} from process.env.${RUSH_LIB_PATH_ENV_VAR_NAME} from caller package`\n    );\n    try {\n      sdkContext.rushLibModule = _require(rushLibPath);\n    } catch (error) {\n      // Log this as a warning, since it is unexpected to define an incorrect value of the variable.\n      terminal.writeWarningLine(\n        `Failed to load ${RUSH_LIB_NAME} via process.env.${RUSH_LIB_PATH_ENV_VAR_NAME}`\n      );\n    }\n\n    if (sdkContext.rushLibModule !== undefined) {\n      // to track which scenario is active and how it got initialized.\n      global.___rush___rushLibModuleFromEnvironment = sdkContext.rushLibModule;\n      terminal.writeVerboseLine(`Loaded ${RUSH_LIB_NAME} from process.env.${RUSH_LIB_PATH_ENV_VAR_NAME}`);\n    }\n  }\n}\n\n// SCENARIO 4:  A standalone tool or script depends on \"rush-sdk\", and is meant to be used inside a monorepo folder.\n// In this case, we can use install-run-rush.js to obtain the appropriate rush-lib version for the monorepo.\nif (sdkContext.rushLibModule === undefined) {\n  try {\n    const rushJsonPath: string | undefined = tryFindRushJsonLocation(process.cwd());\n    if (!rushJsonPath) {\n      throw new Error(\n        'Unable to find rush.json in the current folder or its parent folders.\\n' +\n          'This tool is meant to be invoked from a working directory inside a Rush repository.'\n      );\n    }\n    const monorepoRoot: string = path.dirname(rushJsonPath);\n\n    const rushJson: JsonObject = JsonFile.load(rushJsonPath);\n    const { rushVersion } = rushJson;\n\n    const installRunNodeModuleFolder: string = path.join(\n      monorepoRoot,\n      `common/temp/install-run/@microsoft+rush@${rushVersion}`\n    );\n\n    try {\n      // First, try to load the version of \"rush-lib\" that was installed by install-run-rush.js\n      terminal.writeVerboseLine(`Trying to load  ${RUSH_LIB_NAME} installed by install-run-rush`);\n      sdkContext.rushLibModule = requireRushLibUnderFolderPath(installRunNodeModuleFolder);\n    } catch (e1) {\n      let installAndRunRushStderrContent: string = '';\n      try {\n        const installAndRunRushJSPath: string = path.join(monorepoRoot, 'common/scripts/install-run-rush.js');\n\n        terminal.writeLine('The Rush engine has not been installed yet. Invoking install-run-rush.js...');\n\n        const installAndRunRushProcess: SpawnSyncReturns<string> = Executable.spawnSync(\n          'node',\n          [installAndRunRushJSPath, '--help'],\n          {\n            stdio: 'pipe'\n          }\n        );\n\n        installAndRunRushStderrContent = installAndRunRushProcess.stderr;\n        if (installAndRunRushProcess.status !== 0) {\n          throw new Error(`The ${RUSH_LIB_NAME} package failed to install`);\n        }\n\n        // Retry to load \"rush-lib\" after install-run-rush run\n        terminal.writeVerboseLine(\n          `Trying to load  ${RUSH_LIB_NAME} installed by install-run-rush a second time`\n        );\n        sdkContext.rushLibModule = requireRushLibUnderFolderPath(installRunNodeModuleFolder);\n      } catch (e2) {\n        // eslint-disable-next-line no-console\n        console.error(`${installAndRunRushStderrContent}`);\n        throw new Error(`The ${RUSH_LIB_NAME} package failed to load`);\n      }\n    }\n\n    if (sdkContext.rushLibModule !== undefined) {\n      // to track which scenario is active and how it got initialized.\n      global.___rush___rushLibModuleFromInstallAndRunRush = sdkContext.rushLibModule;\n      terminal.writeVerboseLine(`Loaded ${RUSH_LIB_NAME} installed by install-run-rush`);\n    }\n  } catch (e) {\n    // no-catch\n    errorMessage = (e as Error).message;\n  }\n}\n\nif (sdkContext.rushLibModule === undefined) {\n  // This error indicates that a project is trying to import \"@rushstack/rush-sdk\", but the Rush engine\n  // instance cannot be found.  If you are writing Jest tests for a Rush plugin, add \"@microsoft/rush-lib\"\n  // to the devDependencies for your project.\n  // eslint-disable-next-line no-console\n  console.error(`Error: The @rushstack/rush-sdk package was not able to load the Rush engine:\n${errorMessage}\n`);\n  process.exit(1);\n}\n\n// Based on TypeScript's __exportStar()\nfor (const property in sdkContext.rushLibModule) {\n  if (property !== 'default' && !exports.hasOwnProperty(property)) {\n    const rushLibModuleForClosure: RushLibModuleType = sdkContext.rushLibModule;\n\n    // Based on TypeScript's __createBinding()\n    Object.defineProperty(exports, property, {\n      enumerable: true,\n      get: function () {\n        return rushLibModuleForClosure[property];\n      }\n    });\n  }\n}\n\n/**\n * Used by the .js stubs for path-based imports of `@microsoft/rush-lib` internal APIs.\n */\nexport function _rushSdk_loadInternalModule(srcImportPath: string): unknown {\n  if (!exports._RushInternals) {\n    throw new Error(\n      `Rush version ${exports.Rush.version} does not support internal API imports via rush-sdk`\n    );\n  }\n  return exports._RushInternals.loadModule(srcImportPath);\n}\n"]}