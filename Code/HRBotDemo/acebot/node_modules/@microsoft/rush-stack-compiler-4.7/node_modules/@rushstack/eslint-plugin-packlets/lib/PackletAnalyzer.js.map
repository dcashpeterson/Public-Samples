{"version":3,"file":"PackletAnalyzer.js","sourceRoot":"","sources":["../src/PackletAnalyzer.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport * as fs from 'fs';\nimport { Path } from './Path';\n\nexport type InputFileMessageIds =\n  | 'file-in-packets-folder'\n  | 'invalid-packlet-name'\n  | 'misplaced-packlets-folder'\n  | 'missing-src-folder'\n  | 'missing-tsconfig'\n  | 'packlet-folder-case';\n\nexport type ImportMessageIds =\n  | 'bypassed-entry-point'\n  | 'circular-entry-point'\n  | 'packlet-importing-project-file';\n\nexport interface IAnalyzerError {\n  messageId: InputFileMessageIds | ImportMessageIds;\n  data?: Readonly<Record<string, unknown>>;\n}\n\nexport class PackletAnalyzer {\n  private static _validPackletName: RegExp = /^[a-z0-9]+(-[a-z0-9]+)*$/;\n\n  /**\n   * The input file being linted.\n   *\n   * Example: \"/path/to/my-project/src/file.ts\"\n   */\n  public readonly inputFilePath: string;\n\n  /**\n   * An error that occurred while analyzing the inputFilePath.\n   */\n  public readonly error: IAnalyzerError | undefined;\n\n  /**\n   * Returned to indicate that the linter can ignore this file.  Possible reasons:\n   * - It's outside the \"src\" folder\n   * - The project doesn't define any packlets\n   */\n  public readonly nothingToDo: boolean;\n\n  /**\n   * If true, then the \"src/packlets\" folder exists.\n   */\n  public readonly projectUsesPacklets: boolean;\n\n  /**\n   * The absolute path of the \"src/packlets\" folder.\n   */\n  public readonly packletsFolderPath: string | undefined;\n\n  /**\n   * The packlet that the inputFilePath is under, if any.\n   */\n  public readonly inputFilePackletName: string | undefined;\n\n  /**\n   * Returns true if inputFilePath belongs to a packlet and is the entry point index.ts.\n   */\n  public readonly isEntryPoint: boolean;\n\n  private constructor(inputFilePath: string, tsconfigFilePath: string | undefined) {\n    this.inputFilePath = inputFilePath;\n    this.error = undefined;\n    this.nothingToDo = false;\n    this.projectUsesPacklets = false;\n    this.packletsFolderPath = undefined;\n    this.inputFilePackletName = undefined;\n    this.isEntryPoint = false;\n\n    // Example: /path/to/my-project/src\n    let srcFolderPath: string | undefined;\n\n    if (!tsconfigFilePath) {\n      this.error = { messageId: 'missing-tsconfig' };\n      return;\n    }\n\n    srcFolderPath = Path.join(Path.dirname(tsconfigFilePath), 'src');\n\n    if (!fs.existsSync(srcFolderPath)) {\n      this.error = { messageId: 'missing-src-folder', data: { srcFolderPath } };\n      return;\n    }\n\n    if (!Path.isUnder(inputFilePath, srcFolderPath)) {\n      // Ignore files outside the \"src\" folder\n      this.nothingToDo = true;\n      return;\n    }\n\n    // Example: packlets/my-packlet/index.ts\n    const inputFilePathRelativeToSrc: string = Path.relative(srcFolderPath, inputFilePath);\n\n    // Example: [ 'packlets', 'my-packlet', 'index.ts' ]\n    const pathParts: string[] = inputFilePathRelativeToSrc.split(/[\\/\\\\]+/);\n\n    let underPackletsFolder: boolean = false;\n\n    const expectedPackletsFolder: string = Path.join(srcFolderPath, 'packlets');\n\n    for (let i = 0; i < pathParts.length; ++i) {\n      const pathPart: string = pathParts[i];\n      if (pathPart.toUpperCase() === 'PACKLETS') {\n        if (pathPart !== 'packlets') {\n          // Example: /path/to/my-project/src/PACKLETS\n          const packletsFolderPath: string = Path.join(srcFolderPath, ...pathParts.slice(0, i + 1));\n          this.error = { messageId: 'packlet-folder-case', data: { packletsFolderPath } };\n          return;\n        }\n\n        if (i !== 0) {\n          this.error = { messageId: 'misplaced-packlets-folder', data: { expectedPackletsFolder } };\n          return;\n        }\n\n        underPackletsFolder = true;\n      }\n    }\n\n    if (underPackletsFolder || fs.existsSync(expectedPackletsFolder)) {\n      // packletsAbsolutePath\n      this.projectUsesPacklets = true;\n      this.packletsFolderPath = expectedPackletsFolder;\n    }\n\n    if (underPackletsFolder) {\n      if (pathParts.length === 2) {\n        // Example: src/packlets/SomeFile.ts\n        this.error = { messageId: 'file-in-packets-folder' };\n        return;\n      }\n      if (pathParts.length >= 2) {\n        // Example: 'my-packlet'\n        const packletName: string = pathParts[1];\n        this.inputFilePackletName = packletName;\n\n        if (pathParts.length === 3) {\n          // Example: 'index.ts' or 'index.tsx'\n          const thirdPart: string = pathParts[2];\n\n          // Example: 'index'\n          const thirdPartWithoutExtension: string = Path.parse(thirdPart).name;\n\n          if (thirdPartWithoutExtension.toUpperCase() === 'INDEX') {\n            if (!PackletAnalyzer._validPackletName.test(packletName)) {\n              this.error = { messageId: 'invalid-packlet-name', data: { packletName } };\n              return;\n            }\n\n            this.isEntryPoint = true;\n          }\n        }\n      }\n    }\n\n    if (this.error === undefined && !this.projectUsesPacklets) {\n      this.nothingToDo = true;\n    }\n  }\n\n  public static analyzeInputFile(inputFilePath: string, tsconfigFilePath: string | undefined) {\n    return new PackletAnalyzer(inputFilePath, tsconfigFilePath);\n  }\n\n  public analyzeImport(modulePath: string): IAnalyzerError | undefined {\n    if (!this.packletsFolderPath) {\n      // The caller should ensure this can never happen\n      throw new Error('Internal error: packletsFolderPath is not defined');\n    }\n\n    // Example: /path/to/my-project/src/packlets/my-packlet\n    const inputFileFolder: string = Path.dirname(this.inputFilePath);\n\n    // Example: /path/to/my-project/src/other-packlet/index\n    const importedPath: string = Path.resolve(inputFileFolder, modulePath);\n\n    // Is the imported path referring to a file under the src/packlets folder?\n    if (Path.isUnder(importedPath, this.packletsFolderPath)) {\n      // Example: other-packlet/index\n      const importedPathRelativeToPackletsFolder: string = Path.relative(\n        this.packletsFolderPath,\n        importedPath\n      );\n      // Example: [ 'other-packlet', 'index' ]\n      const importedPathParts: string[] = importedPathRelativeToPackletsFolder.split(/[\\/\\\\]+/);\n      if (importedPathParts.length > 0) {\n        // Example: 'other-packlet'\n        const importedPackletName: string = importedPathParts[0];\n\n        // We are importing from a packlet. Is the input file part of the same packlet?\n        if (this.inputFilePackletName && importedPackletName === this.inputFilePackletName) {\n          // Yes.  Then our import must NOT use the packlet entry point.\n\n          // Example: 'index'\n          //\n          // We discard the file extension to handle a degenerate case like:\n          //   import { X } from \"../index.js\";\n          const lastPart: string = Path.parse(importedPathParts[importedPathParts.length - 1]).name;\n          let pathToCompare: string;\n          if (lastPart.toUpperCase() === 'INDEX') {\n            // Example:\n            //   importedPath = /path/to/my-project/src/other-packlet/index\n            //   pathToCompare = /path/to/my-project/src/other-packlet\n            pathToCompare = Path.dirname(importedPath);\n          } else {\n            pathToCompare = importedPath;\n          }\n\n          // Example: /path/to/my-project/src/other-packlet\n          const entryPointPath: string = Path.join(this.packletsFolderPath, importedPackletName);\n\n          if (Path.isEqual(pathToCompare, entryPointPath)) {\n            return {\n              messageId: 'circular-entry-point'\n            };\n          }\n        } else {\n          // No.  If we are not part of the same packlet, then the module path must refer\n          // to the index.ts entry point.\n\n          // Example: /path/to/my-project/src/other-packlet\n          const entryPointPath: string = Path.join(this.packletsFolderPath, importedPackletName);\n\n          if (!Path.isEqual(importedPath, entryPointPath)) {\n            // Example: \"../packlets/other-packlet\"\n            const entryPointModulePath: string = Path.convertToSlashes(\n              Path.relative(inputFileFolder, entryPointPath)\n            );\n\n            return {\n              messageId: 'bypassed-entry-point',\n              data: { entryPointModulePath }\n            };\n          }\n        }\n      }\n    } else {\n      // The imported path does NOT refer to a file under the src/packlets folder\n      if (this.inputFilePackletName) {\n        return {\n          messageId: 'packlet-importing-project-file'\n        };\n      }\n    }\n\n    return undefined;\n  }\n}\n"]}