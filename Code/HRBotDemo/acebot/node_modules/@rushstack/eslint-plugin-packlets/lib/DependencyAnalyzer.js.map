{"version":3,"file":"DependencyAnalyzer.js","sourceRoot":"","sources":["../src/DependencyAnalyzer.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport type * as ts from 'typescript';\r\n\r\nimport { Path } from './Path';\r\nimport { PackletAnalyzer } from './PackletAnalyzer';\r\n\r\nenum RefFileKind {\r\n  Import,\r\n  ReferenceFile,\r\n  TypeReferenceDirective\r\n}\r\n\r\n// TypeScript compiler internal:\r\n// Version range: >= 3.6.0, <= 4.2.0\r\n// https://github.com/microsoft/TypeScript/blob/5ecdcef4cecfcdc86bd681b377636422447507d7/src/compiler/program.ts#L541\r\ninterface RefFile {\r\n  // The absolute path of the module that was imported.\r\n  // (Normalized to an all lowercase ts.Path string.)\r\n  referencedFileName: string;\r\n  // The kind of reference.\r\n  kind: RefFileKind;\r\n  // An index indicating the order in which items occur in a compound expression\r\n  index: number;\r\n\r\n  // The absolute path of the source file containing the import statement.\r\n  // (Normalized to an all lowercase ts.Path string.)\r\n  file: string;\r\n}\r\n\r\n// TypeScript compiler internal:\r\n// Version range: > 4.2.0\r\n// https://github.com/microsoft/TypeScript/blob/2eca17d7c1a3fb2b077f3a910d5019d74b6f07a0/src/compiler/types.ts#L3693\r\nenum FileIncludeKind {\r\n  RootFile,\r\n  SourceFromProjectReference,\r\n  OutputFromProjectReference,\r\n  Import,\r\n  ReferenceFile,\r\n  TypeReferenceDirective,\r\n  LibFile,\r\n  LibReferenceDirective,\r\n  AutomaticTypeDirectiveFile\r\n}\r\n\r\n// TypeScript compiler internal:\r\n// Version range: > 4.2.0\r\n// https://github.com/microsoft/TypeScript/blob/2eca17d7c1a3fb2b077f3a910d5019d74b6f07a0/src/compiler/types.ts#L3748\r\ntype FileIncludeReason = {\r\n  kind: FileIncludeKind;\r\n  file: string | undefined;\r\n};\r\n\r\ninterface ITsProgramInternals extends ts.Program {\r\n  // TypeScript compiler internal:\r\n  // Version range: >= 3.6.0, <= 4.2.0\r\n  // https://github.com/microsoft/TypeScript/blob/5ecdcef4cecfcdc86bd681b377636422447507d7/src/compiler/types.ts#L3723\r\n  getRefFileMap?: () => Map<string, RefFile[]> | undefined;\r\n\r\n  // TypeScript compiler internal:\r\n  // Version range: > 4.2.0\r\n  // https://github.com/microsoft/TypeScript/blob/2eca17d7c1a3fb2b077f3a910d5019d74b6f07a0/src/compiler/types.ts#L3871\r\n  getFileIncludeReasons?: () => Map<string, FileIncludeReason[]>;\r\n}\r\n\r\n/**\r\n * Represents a packlet that imports another packlet.\r\n */\r\nexport interface IPackletImport {\r\n  /**\r\n   * The name of the packlet being imported.\r\n   */\r\n  packletName: string;\r\n\r\n  /**\r\n   * The absolute path of the file that imports the packlet.\r\n   */\r\n  fromFilePath: string;\r\n}\r\n\r\n/**\r\n * Used to build a linked list of imports that represent a circular dependency.\r\n */\r\ninterface IImportListNode extends IPackletImport {\r\n  /**\r\n   * The previous link in the linked list.\r\n   */\r\n  previousNode: IImportListNode | undefined;\r\n}\r\n\r\nexport class DependencyAnalyzer {\r\n  /**\r\n   * @param packletName - the packlet to be checked next in our traversal\r\n   * @param startingPackletName - the packlet that we started with; if the traversal reaches this packlet,\r\n   *   then a circular dependency has been detected\r\n   * @param refFileMap - the compiler's `refFileMap` data structure describing import relationships\r\n   * @param fileIncludeReasonsMap - the compiler's data structure describing import relationships\r\n   * @param program - the compiler's `ts.Program` object\r\n   * @param packletsFolderPath - the absolute path of the \"src/packlets\" folder.\r\n   * @param visitedPacklets - the set of packlets that have already been visited in this traversal\r\n   * @param previousNode - a linked list of import statements that brought us to this step in the traversal\r\n   */\r\n  private static _walkImports(\r\n    packletName: string,\r\n    startingPackletName: string,\r\n    refFileMap: Map<string, RefFile[]> | undefined,\r\n    fileIncludeReasonsMap: Map<string, FileIncludeReason[]> | undefined,\r\n    program: ts.Program,\r\n    packletsFolderPath: string,\r\n    visitedPacklets: Set<string>,\r\n    previousNode: IImportListNode | undefined\r\n  ): IImportListNode | undefined {\r\n    visitedPacklets.add(packletName);\r\n\r\n    const packletEntryPoint: string = Path.join(packletsFolderPath, packletName, 'index');\r\n\r\n    const tsSourceFile: ts.SourceFile | undefined =\r\n      program.getSourceFile(packletEntryPoint + '.ts') || program.getSourceFile(packletEntryPoint + '.tsx');\r\n    if (!tsSourceFile) {\r\n      return undefined;\r\n    }\r\n\r\n    const referencingFilePaths: string[] = [];\r\n\r\n    if (refFileMap) {\r\n      // TypeScript version range: >= 3.6.0, <= 4.2.0\r\n      const refFiles: RefFile[] | undefined = refFileMap.get((tsSourceFile as any).path as any);\r\n      if (refFiles) {\r\n        for (const refFile of refFiles) {\r\n          if (refFile.kind === RefFileKind.Import) {\r\n            referencingFilePaths.push(refFile.file);\r\n          }\r\n        }\r\n      }\r\n    } else if (fileIncludeReasonsMap) {\r\n      // Typescript version range: > 4.2.0\r\n      const fileIncludeReasons: FileIncludeReason[] | undefined = fileIncludeReasonsMap.get(\r\n        (tsSourceFile as any).path as any\r\n      );\r\n      if (fileIncludeReasons) {\r\n        for (const fileIncludeReason of fileIncludeReasons) {\r\n          if (fileIncludeReason.kind === FileIncludeKind.Import) {\r\n            if (fileIncludeReason.file) {\r\n              referencingFilePaths.push(fileIncludeReason.file);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    for (const referencingFilePath of referencingFilePaths) {\r\n      // Is it a reference to a packlet?\r\n      if (Path.isUnder(referencingFilePath, packletsFolderPath)) {\r\n        const referencingRelativePath: string = Path.relative(packletsFolderPath, referencingFilePath);\r\n        const referencingPathParts: string[] = referencingRelativePath.split(/[\\/\\\\]+/);\r\n        const referencingPackletName: string = referencingPathParts[0];\r\n\r\n        // Did we return to where we started from?\r\n        if (referencingPackletName === startingPackletName) {\r\n          // Ignore the degenerate case where the starting node imports itself,\r\n          // since @rushstack/packlets/mechanics will already report that.\r\n          if (previousNode) {\r\n            // Make a new linked list node to record this step of the traversal\r\n            const importListNode: IImportListNode = {\r\n              previousNode: previousNode,\r\n              fromFilePath: referencingFilePath,\r\n              packletName: packletName\r\n            };\r\n\r\n            // The traversal has returned to the packlet that we started from;\r\n            // this means we have detected a circular dependency\r\n            return importListNode;\r\n          }\r\n        }\r\n\r\n        // Have we already analyzed this packlet?\r\n        if (!visitedPacklets.has(referencingPackletName)) {\r\n          // Make a new linked list node to record this step of the traversal\r\n          const importListNode: IImportListNode = {\r\n            previousNode: previousNode,\r\n            fromFilePath: referencingFilePath,\r\n            packletName: packletName\r\n          };\r\n\r\n          const result: IImportListNode | undefined = DependencyAnalyzer._walkImports(\r\n            referencingPackletName,\r\n            startingPackletName,\r\n            refFileMap,\r\n            fileIncludeReasonsMap,\r\n            program,\r\n            packletsFolderPath,\r\n            visitedPacklets,\r\n            importListNode\r\n          );\r\n          if (result) {\r\n            return result;\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  /**\r\n   * For the specified packlet, trace all modules that import it, looking for a circular dependency\r\n   * between packlets.  If found, an array is returned describing the import statements that cause\r\n   * the problem.\r\n   *\r\n   * @remarks\r\n   * For example, suppose we have files like this:\r\n   *\r\n   * ```\r\n   * src/packlets/logging/index.ts\r\n   * src/packlets/logging/Logger.ts --> imports \"../data-model\"\r\n   * src/packlets/data-model/index.ts\r\n   * src/packlets/data-model/DataModel.ts --> imports \"../logging\"\r\n   * ```\r\n   *\r\n   * The returned array would be:\r\n   * ```ts\r\n   * [\r\n   *   { packletName: \"logging\",    fromFilePath: \"/path/to/src/packlets/data-model/DataModel.ts\" },\r\n   *   { packletName: \"data-model\", fromFilePath: \"/path/to/src/packlets/logging/Logger.ts\" },\r\n   * ]\r\n   * ```\r\n   *\r\n   * If there is more than one circular dependency chain, only the first one that is encountered\r\n   * will be returned.\r\n   */\r\n  public static checkEntryPointForCircularImport(\r\n    packletName: string,\r\n    packletAnalyzer: PackletAnalyzer,\r\n    program: ts.Program\r\n  ): IPackletImport[] | undefined {\r\n    const programInternals: ITsProgramInternals = program;\r\n\r\n    let refFileMap: Map<string, RefFile[]> | undefined;\r\n    let fileIncludeReasonsMap: Map<string, FileIncludeReason[]> | undefined;\r\n\r\n    if (programInternals.getRefFileMap) {\r\n      // TypeScript version range: >= 3.6.0, <= 4.2.0\r\n      refFileMap = programInternals.getRefFileMap();\r\n    } else if (programInternals.getFileIncludeReasons) {\r\n      // Typescript version range: > 4.2.0\r\n      fileIncludeReasonsMap = programInternals.getFileIncludeReasons();\r\n    } else {\r\n      // If you encounter this error, please report a bug\r\n      throw new Error(\r\n        'Your TypeScript compiler version is not supported; please upgrade @rushstack/eslint-plugin-packlets' +\r\n          ' or report a GitHub issue'\r\n      );\r\n    }\r\n\r\n    const visitedPacklets: Set<string> = new Set();\r\n\r\n    const listNode: IImportListNode | undefined = DependencyAnalyzer._walkImports(\r\n      packletName,\r\n      packletName,\r\n      refFileMap,\r\n      fileIncludeReasonsMap,\r\n      program,\r\n      packletAnalyzer.packletsFolderPath!,\r\n      visitedPacklets,\r\n      undefined // previousNode\r\n    );\r\n\r\n    if (listNode) {\r\n      // Convert the linked list to an array\r\n      const packletImports: IPackletImport[] = [];\r\n      for (let current: IImportListNode | undefined = listNode; current; current = current.previousNode) {\r\n        packletImports.push({ fromFilePath: current.fromFilePath, packletName: current.packletName });\r\n      }\r\n      return packletImports;\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n}\r\n"]}